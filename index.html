<!DOCTYPE html>
    <head>
        <title>Chana's Avatar</title>
        <style>
            canvas{
                border:1px solid black;
            }
            body{
                margin:0;
            }
            #side-pannel{
                position:absolute;
                top:0;
                left:310px;
                font-family:Arial;
            }
            #camCanvas{
                max-width: 173px;
            }
            #sliders{
                display:none;
            }
            #calibrateBtn{
                display:none;
            }
            #inputContainer{
                display:none;
            }
        </style>
    </head>
    <body>
        <canvas id="myCanvas"></canvas>
        <div id="side-pannel">
            <input type="checkbox" id="debugChk" onchange="toggleDebug(this)">DEBUG</input>
            <br><br>
            <div id="sliders">
                Look at:<br>
                X <input type="range" min="-0.4" max="0.4" step="0.1" onchange="updateLookAt(this,'x')"/>
                <br>
                Y <input type="range" min="-0.2" max="0.2" step="0.05" onchange="updateLookAt(this,'y')"/>
                <br>
                <br>
                Mouth:<br>
                X <input type="range" min="-0.5" max="0.5" step="0.1" onchange="updateMouth(this,'x')"/>
                <br>
                Y <input type="range" min="-0.5" max="0.5" step="0.1" onchange="updateMouth(this,'y')"/>
                <br><br>
            </div>
            <div id="vidOutput">
                <canvas id="camCanvas"></canvas>
                <br><br>
            </div>
            <div id="inputContainer">
                INPUT:
                <br>
                <select name="input" id="input" onchange="onInputChange(this)">
                    <option value="video">video</option>
                    <option value="camera">camera</option>
                    <option value="sliders">sliders</option>
                </select>
                <br><br>
            </div>
            <button id="calibrateBtn" style="background:lightgreen;margin-bottom:10px" onclick="calibrate()">Calibrate</button>
            
            <button id="startBtn" onclick="initializeVideo()">START</button>
            
            <div id="instr"></div>
        </div>

        <script src="controlPanel.js"></script>
        <script src="body.js"></script>
        <script src="physics.js"></script>
        <script src="pendulum.js"></script>
        <script src="doublePendulum.js"></script>
        <script src="camera.js"></script>
        <script src="utils.js"></script>
        <script src="hair.js"></script>
        <script src="beard.js"></script>
        <script src="eye.js"></script>
        <script src="avatar.js"></script>

        <script>
            let DEBUG=false;

            const skinTone="rgb(254,184,150)";
            const shirtColor="rgb(154,153,1)";

            const lookAt={x:0,y:-0.13,initX:0,initY:-0.13,xRange:[0,0.2],yRange:[-0.13,0.1],xOffset:0,yOffset:0};
            const avatar=new Avatar(lookAt,shirtColor,skinTone);
            
            const canvas=document.getElementById("myCanvas");
            const ctx=canvas.getContext("2d");
            initCanvas(300,300);

            animate();

            function initCanvas(width,height){
                canvas.width=width;
                canvas.height=height;
                // prepare canvas so coordinates are in [-1,1]
                ctx.lineWidth=0.01;
                ctx.translate(canvas.width/2,canvas.height/2);
                ctx.scale(canvas.width*0.5,canvas.height*0.5);
            }
            
            function animate(){
                ctx.clearRect(-1,-1,2,2);
                
                if(video){
                    processImage();
                }

                avatar.draw(ctx);
                requestAnimationFrame(animate);
            }

            // called when changing the sliders
            function updateLookAt(info,attr){
                const p=lookAt;
                let yRange=p.yRange;
                let value=info.value;
                if(p.yNegRange){
                    yRange=info.value<0?p.yNegRange:p.yRange;
                    value=Math.abs(value);
                }
                switch(attr){
                    case "x":
                        p.xOffset=info.value; 
                        p.x=lerp(p.xRange[0],p.xRange[1],info.value);
                        break;
                    case "y":
                        p.yOffset=value; 
                        p.y=lerp(yRange[0],yRange[1],value);
                        break;
                }
            }
            
            // called when changing the sliders
            function updateMouth(info,attr){
                switch(attr){
                    case "x":
                        avatar.mouth.x=info.value;
                        break;
                    case "y":
                        avatar.mouth.y=info.value;
                        break;
                }
            }

            function toggleDebug(info){
                DEBUG=info.checked;
            }
        </script>
    </body>
</html>